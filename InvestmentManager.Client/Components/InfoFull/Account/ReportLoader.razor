@inject IJSRuntime jsRuntime
@inject ILocalStorageService localStorage
@inject CustomHttpClient http
@inject NavigationManager navigationManager
@inject CustomNotification notice

<ButtonAction ClickAction="@(async () => await ClickInputFileButtonAsync("inputButton"))" Title="Load .xls reports from Bcs" Color="@Choice.InvestColor.iinfo" />
<InputFile multiple OnChange="HandleSelectionAsync" id="inputButton" style="display:none" />

@code {
    ClaimsPrincipal user = null;
    [CascadingParameter] Task<AuthenticationState> AuthenticationState { get; set; }

    protected override async Task OnInitializedAsync() => user = (await AuthenticationState).User;
    async Task HandleSelectionAsync(IFileListEntry[] files)
    {
        notice.LoadStart();

        if (files != null)
        {
            var content = new MultipartFormDataContent();
            foreach (var file in files)
            {
                var ms = new MemoryStream();
                await file.Data.CopyToAsync(ms);
                content.Add(new ByteArrayContent(ms.GetBuffer()), file.Name, file.Name);
                ms.Close();
            }

            var response = await http.PostAsContentAsync(RouteName.brokerReport + "/parsebcs", content).ConfigureAwait(false);
            content.Dispose();

            if (response.IsSuccessStatusCode)
            {
                var reportModel = JsonSerializer.Deserialize<BrokerReportModel>(await response.Content.ReadAsStringAsync().ConfigureAwait(false), new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                await localStorage.SetItemAsync<BrokerReportModel>($"{user.Identity.Name}_bcsReport", reportModel).ConfigureAwait(false);
                navigationManager.NavigateTo("brokerreports");
            }
            else
            {
                notice.LoadStop();
                await notice.AlertFailedAsync();
            }
        }
    }
    async Task ClickInputFileButtonAsync(string inputFileId)
    {
        if (user is null || !user.Identity.IsAuthenticated)
            await notice.AlertAccessAsync();
        else
            await jsRuntime.InvokeVoidAsync("uploadBrokerReports", inputFileId);
    }
}
