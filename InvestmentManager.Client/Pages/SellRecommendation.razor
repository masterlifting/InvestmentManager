@page "/sellrecommendation"
@inject HttpClient httpClient


<AuthorizeView>
    <Authorized>
        @if (Recommendations != null)
        {
            foreach (var r in Recommendations
                .OrderByDescending(x => x.IsRecommendMax)
                .ThenByDescending(x => x.IsRecommendMid)
                .ThenByDescending(x => x.IsRecommendMin)
                .ThenBy(x => (x.PriceMin - x.LastPriceValue)))
            {
                string lastPrice = r.CurrencyId == 2 ? r.LastPriceValue.ToString("C") : r.LastPriceValue.ToString("C", new CultureInfo("en-US"));
                Choices.Color nameColor = r.IsRecommendMin || r.IsRecommendMid || r.IsRecommendMax ? Choices.Color.success : Choices.Color.warning;

                <div class="container invest_card">
                    
                    <RowTitle Color="@nameColor" Text="@r.CompanyName" />

                    @if (_companyId == r.CompanyId)
                    {
                        <StockTransactionDetail CloseDetail="@CloseDetail" CompanyId="@r.CompanyId" />
                    }
                    else
                    {
                        <DetailIcon DetailAction="GetDetail" Value="@r.CompanyId.ToString()" />
                        <RowInfo Title="Цена обновлена:" Value="@r.LastPriceDate" />
                        <RowInfo Color="Choices.Color.info" Title="Последняя цена:" Value="@lastPrice" />
                        <div class="row">
                            <div class="col text-warning">Продавать с прибылью в:</div>
                        </div>
                        @if (r.ValueMin != 0)
                        {
                            string price = r.CurrencyId == 2 ? r.PriceMin.ToString("C") : r.PriceMin.ToString("C", new CultureInfo("en-US"));
                            string view = $"{r.ValueMin} шт. по {price}";
                            Choices.Color color = r.IsRecommendMin ? Choices.Color.success : Choices.Color.danger;
                            <RowInfo Color="@color" Title="20%" Value="@view" />
                        }
                        @if (r.ValueMid != 0)
                        {
                            string price = r.CurrencyId == 2 ? r.PriceMid.ToString("C") : r.PriceMid.ToString("C", new CultureInfo("en-US"));
                            string view = $"{r.ValueMid} шт. по {price}";
                            Choices.Color color = r.IsRecommendMid ? Choices.Color.success : Choices.Color.danger;
                            <RowInfo Color="@color" Title="50%" Value="@view" />
                        }
                        @if (r.ValueMax != 0)
                        {
                            string price = r.CurrencyId == 2 ? r.PriceMax.ToString("C") : r.PriceMax.ToString("C", new CultureInfo("en-US"));
                            string view = $"{r.ValueMax} шт. по {price}";
                            Choices.Color color = r.IsRecommendMax ? Choices.Color.success : Choices.Color.danger;
                            <RowInfo Color="@color" Title="80%" Value="@view" />
                        }
                    }
                </div>
            }
        }
    </Authorized>
</AuthorizeView>

@code {
    long _companyId = 0;

    IEnumerable<SellRecommendationModel> Recommendations;
    protected override async Task OnInitializedAsync() =>
    Recommendations = await httpClient.GetFromJsonAsync<IEnumerable<SellRecommendationModel>>("recommendation/sellr");
    void GetDetail(string companyId) => _companyId = long.Parse(companyId);
    void CloseDetail() => _companyId = 0;
}
